package org.powerhigh.game;

import java.awt.Component;
import java.awt.Toolkit;

import org.powerhigh.Camera;
import org.powerhigh.audio.Audio;
import org.powerhigh.graphics.ErrorBox;
import org.powerhigh.graphics.Window;
import org.powerhigh.input.Input;
import org.powerhigh.utils.LGGLException;
import org.powerhigh.utils.debug.DebugLogger;

public abstract class SimpleGame {

	protected Window window = null;
	protected Audio audio = null;
	protected Camera camera = null;
	protected Input input = null;
	
	public static boolean enableLaunchDebug = true;

	public abstract void update(Window win, double delta);

	public abstract void init(Window win);
	
	public void exit(Window win) {}

	private void dbg() {
		String name = System.getProperty("os.name");
		String ver = System.getProperty("os.version");
		DebugLogger.logInfo("Operating System is " + name + "/" + ver);
	}
	
	public static class ImplementationSettings {
		
		private Interface itrf;
		private Audio audio;
		
		public static enum Interface {
			SWING,
			OPENGL,
			ANDROID;
		}
		
		public static enum Audio {
			AWT,
			OPENAL,
			ANDROID;
		}
		
		public ImplementationSettings(Interface itrf, Audio audio) {
			this.itrf = itrf;
			this.audio = audio;
		}
		
		public Interface getInterfaceType() {
			return itrf;
		}
		
		public Audio getAudioType() {
			return audio;
		}
		
	}
	
	public abstract ImplementationSettings getImplementationSettings();
	
	/**
	 * Core init of game, if overriding this method, add <code>super.coreInit()</code> unless you know what you're doing !
	 * <p><b>Note:</b> This method is called before init, it is like a pre-init</p>
	 */
	protected void coreInit() {
		window = new Window();
		try {
			audio = new Audio();
			if (enableLaunchDebug)
				DebugLogger.logInfo("Audio ready !");
		} catch (LGGLException e) {
			System.err.println("Error when creating Audio system! Aborting.");
			e.printStackTrace();
			System.exit(1);
		}
		input = new Input(window);
		camera = new Camera(0, 0);
	}
	
	public Audio getAudio() {
		return audio;
	}
	
	public void setFrameRate(int frames) {
		if (window != null) {
			window.getEventThread().setFrameRate(frames);
		}
	}

	protected boolean launched, a1;
	
	public void start() {
		try {
			
			if (enableLaunchDebug) {
				DebugLogger.logInfo("Preparing game..");
				dbg();
			}
			
			coreInit();
			init(window);
			window.show();
			
			window.getEventThread().addUpdateListener(new Runnable() {
				public void run() {
					try {
						update(window, window.getEventThread().getDelta());
						if (window.isClosed() && !window.isFullscreen() && a1 == false) {
							exit(window);
							a1 = true;
						}
					} catch (Throwable t) {
						Component parent = window.getJFrame().getContentPane();
						if (!window.isVisible()) {
							parent = null;
						}
						Toolkit.getDefaultToolkit().beep();
						t.printStackTrace();
						ErrorBox.create()
							.throwable(t)
								.show(parent);
						System.exit(1);
					}
				}
			});
			
			while (true) {
				Thread.sleep(1000 / 60);
				if (!launched) {
					if (enableLaunchDebug) {
						DebugLogger.logInfo("Game launched");
					}
					launched = true;
				}
			}
		} catch (Throwable t) {
			Component parent = window.getJFrame().getContentPane();
			if (!window.isVisible()) {
				parent = null;
			}
			Toolkit.getDefaultToolkit().beep();
			t.printStackTrace();
			ErrorBox.create()
				.throwable(t)
					.show(parent);
			System.exit(1);
		}
	}
}
